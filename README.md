<!--
            Author: Erick Gallesio
     Creation date: 30-Nov-2017 16:05
  Last file update:  1-Dec-2017 15:07 (eg)
-->


# ArduinoML implementation in Scheme

This directory is a quick and dirty implementation of ArduinoML in
Scheme.  

For the the implementation of the ArduinoML, we use here a simple
Scheme (non hygienic) macro.

# Define-application special form 

## Syntax

The following example exhibits the various aspects of the
`define-application` special form:

```scheme
(define-application Simple
  :bricks
  ((button sensor 9)
   (led actuator 12))
  :states
  ((on  (set led "HIGH"))
   (off (set led "LOW")))
  :initial
  off
  :transitions
  ((on -> off when_is button "HIGH")
   (off -> on when_is button "HIGH")))
```

## Using the define-application form

We have two implementations of the `define-application` special form:

- `arduino.scm` works at least in the following Scheme
    - [STklos v1.10](http://stklos.net)
    - [Gauche 0.9.5](http://practical-scheme.net/gauche)
    - [GNU Guile 2.2.2](https://www.gnu.org/software/guile/)
- `arduino.ss` is a version for [Racket v6.15](http://racket-lang.org)

Some tests are present in thedirectory `Examples`. To produce (on the
standard output) the arduino code for the file
`Examples/example1.scm`, you need to enter:

- for **STklos**

  ```bash
  $ stklos  -l arduino.scm -f Examples/example1.scm 
  ```

- for **Gauche**

  ```bash
  $ gosh -I. -l arduino.scm Examples/example1.scm
  ```

- for **GNU Guile** (the sed command used here are sed to

  ```bash
  $ guile --no-auto-compile -l arduino.scm -s Examples/example1.scm
  ```

- for **Racket**  (be sure to use `arduino.ss` instead of `arduino.scm`)

  ```bash
  $ racket -f arduino.ss -f Examples/example1.scm
  ```

## Code produced

The code produced by `define-application` for the previous example is:

```c
// File generated by arduinoML (Scheme)

long time = 0;
long debounce = 200;

int button = 9;
int led = 12;

void setup() {
  pinMode(button, INPUT);
  pinMode(led, OUTPUT);
}

void state_on() {
  digitalWrite(led, HIGH);
  boolean guard =  millis() - time > debounce;
  if (digitalRead(button) == HIGH  && guard) {
    time = millis()
    state_off();
  } else {
    state_on();
  }
}

void state_off() {
  digitalWrite(led, LOW);
  boolean guard =  millis() - time > debounce;
  if (digitalRead(button) == HIGH  && guard) {
    time = millis()
    state_on();
  } else {
    state_off();
  }
}

void loop () {
   state_off();
}
```
